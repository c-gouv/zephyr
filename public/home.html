<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zephyr | Home</title>
    <link rel="stylesheet" href="./css/home.css">
    <link rel="shortcut icon" href="./assets/img/logo.ico">
    <script src="https://kit.fontawesome.com/d94da5d75d.js" crossorigin="anonymous"></script>
    <script src="./js/sessao.js"></script>
</head>
<body onload="atualizarFeed(), validarSessao()">
    <header>
        <img src="./assets/img/logo.svg" class="headerLogo" onclick="resetarFeed()">
        <div class="barraPesquisa">
            <i class="fa-solid fa-magnifying-glass iconPesquisa" style="display: flex;"></i>
            <hr style="height: 100%; width: 2px; background-color: white; border: none;">
            <input type="text" class="inputPesquisa">
        </div>
        <div class="headerUserArea">
            <i class="fa-regular fa-bell iconSino"></i>
            <img src="./assets/img/pfpIcon.svg" class="iconPfp">
        </div>
    </header>
    <main>
        <div class="feed" id="feed_container">
            <div class="feedSection">
                <a>Seguindo</a>
                <a>Feed</a>
            </div>
            <div id="feedPost"></div>
        </div>
        <div class="secondContainer">
            <span class="secondContainerTitulo">Faça uma postagem!</span>
            <div style="display: flex;">
                <div class="secondContainerCard" id="publicarModalTexto" onclick="abrirModal()">
                    <i class="fa-solid fa-pencil"></i>
                    <span>Texto e<br>
                    Imagens</span>
                </div>
                <div class="secondContainerCard">
                    <i class="fa-solid fa-image"></i>
                    <span>Imagens</span>
                </div>
            </div>
            
        </div>
        <div class="modalPublicar" id="modalPublicar">
            <div class="modalPublicarTitulo">
                <h2>Publicar</h2>
                <i class="fa-regular fa-circle-xmark" onclick="fecharModal()" id="iconFecharModal"></i>
            </div>
            <hr>
            <div class="modalPublicarContent">
                <div class="titulo-container">
                    Título
                    <input id="publicarTitulo" type="text" required class="modal-post-title" placeholder="Insira o título (Obrigatório)">
                </div>
                <div class="conteudo-container">
                    Conteúdo
                    <textarea id="publicarTexto" class="modal-post-content"></textarea>
                </div>
                <div class="img-uploader">
                    Imagem
                    <input type="file" class="modal-post-img">
                </div>
                <button onclick="publicar()">Enviar</button>
            </form>
        </div>
    </main>
</body>
</html>

<script>
    // CARREGAR FEED ---------------------------------------------------------------------------------
    function atualizarFeed() {
        fetch("/feed/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var feed = document.getElementById("feedPost");
                    feed.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {
                        var post = resposta[i];

                        feed.innerHTML += `
                        <div class="feedPost">
                            <div class="postUserInfo">
                                <img src="./assets/img/pfpIcon.svg" class="iconPost">
                                <div class="postUserText">
                                    <span class="postUserNome">${post.usuario}</span>
                                    <span class="postUserHora">4h atras</span>
                                </div>
                            </div>
                            <div class="postContentContainer">
                                <h2 class="tituloPost">${post.titulo}</h2>
                                <span class="postTexto">${post.descricao}</span>
                                <div class="partyList">
                                    <img src="./assets/img/plusIcon.svg" class="iconPost">
                                    <img src="./assets/img/plusIcon.svg" class="iconPost">
                                    <img src="./assets/img/plusIcon.svg" class="iconPost">
                                    <img src="./assets/img/plusIcon.svg" class="iconPost">
                                    <img src="./assets/img/plusIcon.svg" class="iconPost">
                                </div>
                            </div>
                            <div class="postInteracao">
                                <div class="interacao" id="divCurtida">
                                    <i class="fa-regular fa-heart postInteracaoIcon" id="iconCurtida"></i> 300
                                </div>
                                <div class="interacao" id="divComent">
                                    <i class="fa-regular fa-comments postInteracaoIcon" id="iconComent"></i> 227
                                </div>
                            </div>
                        </div>`
                    }
                    allTools();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }
    // HOVER CONTEUDO POSTAGEM --------------------------------------------------------------------------
    function allTools() {
        const titulosPost = document.querySelectorAll(".postContentContainer");
        titulosPost.forEach(titulo => {
            titulo.addEventListener("mouseover", evidenciarTitulo);
            titulo.addEventListener("mouseout", retornarTitulo);
        });
        const botaoLike = document.querySelectorAll(".fa-heart");
        botaoLike.forEach(like => {
            like.addEventListener("click", trocarBotaoLike)
        });
    }
    function resetarFeed(){
        window.location.reload()
    }
    function evidenciarTitulo(event) {
        const tituloPost = event.currentTarget.querySelector(".tituloPost");
        tituloPost.classList.add("evidenciarElementoHover");
    }
    function retornarTitulo(event) {
        const tituloPost = event.currentTarget.querySelector(".tituloPost");
        tituloPost.classList.remove("evidenciarElementoHover");
    }
    // BOTAO LIKE --------------------------------------------------------------------------------------
    function trocarBotaoLike(e){
        let icone = e.currentTarget
        let estadoAtual = icone.classList.contains("fa-regular") ? "fa-regular" : "fa-solid";
        let novoEstado = estadoAtual === "fa-regular" ? "fa-solid" : "fa-regular";
        
        icone.classList.remove(estadoAtual);
        icone.classList.add(novoEstado);
        icone.classList.toggle("evidenciarElementoHover")
    }
    // PUBLICAR ----------------------------------------------------------------------------------------
    function publicar() {
        var idUsuario = sessionStorage.ID_USUARIO;
        const tituloPost = publicarTitulo.value
        const conteudoPost = publicarTexto.value

        var corpo = {
            titulo: tituloPost,
            conteudo: conteudoPost
        }

        fetch(`/feed/publicar/${idUsuario}`, {
            method: "post",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(corpo)
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                window.location = "/home.html";
                // limparFormulario();
                // finalizarAguardar();
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            // finalizarAguardar();
        });
        return false;
    }
    // FECHAR/ABRIR PUBLICAR ---------------------------------------------------------------------------
    function abrirModal(){
        const modalPublicarTexto = document.getElementById("modalPublicar")
        modalPublicarTexto.style.display = 'block'
    }
    function fecharModal(){
        const modalPublicarTexto = document.getElementById("modalPublicar")
        modalPublicarTexto.style.display = 'none'

    }
</script>